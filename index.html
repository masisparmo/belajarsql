<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUDAH BELAJAR SQL & DATA ANALITIK</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            box-sizing: border-box;
        }
        h1, h2, h3 { text-align: center; color: #444; }
        .main-container { display: flex; flex-direction: column; flex-grow: 1; gap: 20px; min-height: 0; }
        .content-wrapper { display: flex; flex-direction: row; flex-grow: 1; gap: 20px; min-height: 0; flex-wrap: wrap; }
        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; flex: 1; min-width: 400px; }
        .box { background-color: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .upload-section { border-style: dashed; border-color: var(--primary-color); }
        #csv-upload { display: none; }
        .upload-button { background-color: var(--primary-color); color: white; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: inline-block; transition: background-color 0.2s; }
        textarea { width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Courier New', Courier, monospace; font-size: 14px; box-sizing: border-box; }
        .action-buttons { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
        button, .dataset-link { padding: 10px 15px; border: none; color: white; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; text-decoration: none; }
        .dataset-link { background-color: #5a6268; padding: 8px 12px; font-size: 13px; }
        .dataset-link:hover { background-color: #4a5258; }
        button.data-source-btn { background-color: var(--secondary-color); }
        button.data-source-btn.active { background-color: var(--primary-color); font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #run-button { background-color: var(--success-color); }
        #export-csv-button { background-color: var(--info-color); display: none; }
        #analyze-data-btn { background-color: var(--warning-color); color: #212529; }
        #clean-data-btn { background-color: var(--danger-color); }
        #help-button { background-color: var(--secondary-color); }
        #result-container { flex-grow: 1; overflow: auto; background-color: #fff; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        #result-table { width: 100%; border-collapse: collapse; }
        #result-table th, #result-table td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
        #result-table th { background-color: var(--light-bg); position: sticky; top: -16px; }
        #error-message { color: var(--danger-color); font-weight: bold; white-space: pre-wrap; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        #analysis-report { margin-top: 15px; font-size: 14px; max-height: 300px; overflow-y: auto; }
        #analysis-report h4 { margin-top: 15px; margin-bottom: 5px; color: #0056b3; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        #analysis-report code { background-color: #e9ecef; padding: 2px 4px; border-radius: 3px; }
        #analysis-report .data-table-wrapper { max-height: 150px; overflow: auto; }
        .preview-table { width: 100%; border-collapse: collapse; }
        .preview-table th, .preview-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 13px; white-space: nowrap; }
        .preview-table th { background-color: var(--light-bg); position: sticky; top: 0; }
        #cleaning-log { margin-top: 15px; background-color: #212529; color: #0f0; font-family: 'Courier New', monospace; padding: 15px; border-radius: 5px; font-size: 14px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 20px 30px; border-radius: 8px; max-width: 750px; width: 90%; max-height: 85vh; overflow-y: auto; position: relative; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; border: none; background: none; cursor: pointer; color: #888; }
        .modal-content h2 { margin-top: 0; color: #333; }
        .modal-content h3 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 25px; }
        .modal-content p { line-height: 1.6; }
        .modal-content pre { background-color: #f1f1f1; padding: 15px; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; border-left: 4px solid var(--primary-color); }
        .modal-content code { font-family: 'Courier New', Courier, monospace; }
        .data-cleaning-section { background-color: #e7f3ff; padding: 15px; border-radius: 5px; border-left: 4px solid var(--primary-color); margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="main-container">
        <h1>Analisis Data & SQL Runner</h1>
        <div class="content-wrapper">
            <div class="left-panel">
                <div class="box" id="sample-data-box">
                    <h3>1. Mulai dengan Contoh Data</h3>
                    <div class="preview-table-wrapper">
                        <table id="sample-data-preview-table" class="preview-table"></table>
                    </div>
                     <div id="data-source-box" style="margin-top: 15px;">
                        <p>Sumber data yang tersedia:</p>
                        <div id="data-source-buttons" class="action-buttons"></div>
                    </div>
                </div>

                <div class="box upload-section">
                    <label for="csv-upload">2. Atau Unggah File Sendiri</label>
                    <input type="file" id="csv-upload" accept=".csv, .txt">
                    <label for="csv-upload" class="upload-button">Unggah File CSV</label>
                    <p id="upload-status"></p>
                </div>

                <div class="box" id="public-dataset-box">
                    <h3>Contoh Public Dataset</h3>
                    <p>Klik kanan > "Simpan tautan sebagai..." untuk mengunduh, lalu unggah menggunakan tombol di atas.</p>
                    <div class="action-buttons">
                        <a href="https://calmcode.io/static/data/titanic.csv" download="titanic.csv" class="dataset-link">Titanic</a>
                        <a href="https://calmcode.io/static/data/bigmac.csv" download="bigmac.csv" class="dataset-link">Big Mac Index</a>
                        <a href="https://calmcode.io/static/data/smoking.csv" download="smoking.csv" class="dataset-link">Smoking</a>
                        <a href="https://calmcode.io/static/data/fish.csv" download="fish.csv" class="dataset-link">Fish Market</a>
                        <a href="https://calmcode.io/static/data/chickweight.csv" download="chickweight.csv" class="dataset-link">Chick Weight</a>
                        <a href="https://calmcode.io/static/data/stigler.csv" download="stigler.csv" class="dataset-link">Stigler Diet</a>
                    </div>
                </div>

                <div class="box" id="data-quality-box">
                    <h3>3. Alat Kualitas Data</h3>
                    <p>Jalankan alat pada tabel aktif: <code id="active-table-name"></code></p>
                    <div class="action-buttons">
                        <button id="analyze-data-btn">Analisis Data</button>
                        <button id="clean-data-btn">Buat Versi Bersih</button>
                    </div>
                    <div id="analysis-report"></div>
                    <div id="cleaning-log" style="display:none;"></div>
                </div>
            </div>

            <div class="right-panel">
                <div class="box">
                    <h3>4. Editor Kueri SQL</h3>
                    <label for="sample-queries" style="font-weight: bold;">Pilih Contoh Kueri:</label>
                    <select id="sample-queries" style="width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px;"></select>
                    <textarea id="sql-query" placeholder="Tulis kueri SQL di sini..."></textarea>
                    <div class="action-buttons">
                        <button id="run-button">Run Query</button>
                        <button id="export-csv-button">Export to CSV</button>
                        <button id="help-button">Bantuan SQL</button>
                    </div>
                </div>
                <div id="result-container">
                    <h3>Hasil Kueri</h3>
                    <div id="error-message" style="display: none;"></div>
                    <div id="result-table-wrapper">
                        <table id="result-table">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-button">&times;</button>
            <h2>Panduan Lengkap SQL</h2>
            <p>SQL (Structured Query Language) adalah bahasa standar untuk mengelola dan memanipulasi data. Panduan ini akan membantu Anda menggunakan SQL untuk menganalisis dan membersihkan data.</p>
            
            <div class="data-cleaning-section">
                <h3>Analisis dan Pembersihan Data</h3>
                <p>Ini adalah fungsi dan sintaks yang paling penting untuk memperbaiki data yang tidak konsisten seperti pada tabel <code>data_karyawan</code>.</p>
                
                <h4>Mencari Tahu Masalah Data</h4>
                <p><strong>DISTINCT</strong>: Menampilkan nilai unik dari sebuah kolom. Sangat berguna untuk melihat variasi data yang ada.</p>
                <pre><code>-- Melihat semua variasi penulisan 'kota'
SELECT DISTINCT kota FROM data_karyawan;</code></pre>
                
                <p><strong>IS NULL</strong>: Memfilter baris di mana sebuah kolom tidak memiliki nilai (kosong).</p>
                <pre><code>-- Menemukan karyawan yang gajinya belum diisi
SELECT * FROM data_karyawan WHERE gaji IS NULL OR gaji = '';</code></pre>

                <p><strong>LIKE</strong>: Mencari data berdasarkan pola teks. Karakter <code>%</code> mewakili nol atau lebih karakter apa pun.</p>
                <pre><code>-- Mencari nama yang mengandung spasi di awal atau akhir
SELECT nama FROM data_karyawan WHERE nama LIKE ' %' OR nama LIKE '% ';</code></pre>

                <h4>Memperbaiki Masalah Data</h4>
                <p><strong>TRIM()</strong>: Menghapus spasi di awal dan akhir teks.</p>
                <pre><code>-- Membersihkan spasi dari kolom nama
SELECT nama, TRIM(nama) AS nama_bersih FROM data_karyawan;</code></pre>
                
                <p><strong>LOWER() / UPPER()</strong>: Mengubah teks menjadi huruf kecil atau besar untuk menyeragamkan format.</p>
                <pre><code>-- Menyeragamkan data kota menjadi huruf kecil
SELECT kota, LOWER(TRIM(kota)) AS kota_standar FROM data_karyawan;</code></pre>
                
                <p><strong>COALESCE()</strong>: Mengganti nilai NULL atau kosong dengan nilai default yang Anda tentukan.</p>
                <pre><code>-- Mengganti gaji yang kosong dengan 0
SELECT nama, COALESCE(gaji, 0) AS gaji_final FROM data_karyawan;</code></pre>
                
                <p><strong>CASE Statement</strong>: Menerapkan logika kondisional (if-then-else) untuk membuat kolom baru atau mengkategorikan data.</p>
                <pre><code>-- Mengkategorikan gaji karyawan
SELECT nama, gaji,
CASE
    WHEN gaji > 6000000 THEN 'Gaji Tinggi'
    WHEN gaji IS NULL THEN 'Data Hilang'
    ELSE 'Gaji Standar'
END AS level_gaji
FROM data_karyawan;</code></pre>
            </div>

            <h3>Agregasi dan Pengelompokan</h3>
            <p>Fungsi yang melakukan perhitungan pada sekelompok baris.</p>
            <p><strong>COUNT()</strong>: Menghitung jumlah baris.</p>
            <pre><code>-- Menghitung total karyawan
SELECT COUNT(*) FROM data_karyawan;
-- Menghitung karyawan yang emailnya terisi
SELECT COUNT(email) FROM data_karyawan;</code></pre>
            <p><strong>SUM()</strong>: Menjumlahkan nilai numerik.</p>
            <pre><code>-- Menghitung total gaji yang dikeluarkan (mengabaikan NULL)
SELECT SUM(gaji) FROM data_karyawan;</code></pre>
            <p><strong>AVG()</strong>: Menghitung nilai rata-rata.</p>
            <pre><code>-- Menghitung rata-rata gaji
SELECT AVG(gaji) FROM data_karyawan;</code></pre>
            <p><strong>MIN() / MAX()</strong>: Menemukan nilai terkecil atau terbesar.</p>
            <pre><code>-- Melihat gaji terendah dan tertinggi
SELECT MIN(gaji), MAX(gaji) FROM data_karyawan;</code></pre>
            <p><strong>GROUP BY</strong>: Mengelompokkan baris berdasarkan nilai kolom, biasanya digunakan dengan fungsi agregat.</p>
            <pre><code>-- Menghitung jumlah karyawan per kota (setelah dibersihkan)
SELECT LOWER(TRIM(kota)) AS kota_bersih, COUNT(id)
FROM data_karyawan
GROUP BY kota_bersih;</code></pre>
            <p><strong>HAVING</strong>: Memfilter hasil setelah data dikelompokkan oleh <code>GROUP BY</code>.</p>
            <pre><code>-- Menampilkan kota yang memiliki lebih dari 1 karyawan
SELECT LOWER(TRIM(kota)) AS kota_bersih, COUNT(id) AS jumlah
FROM data_karyawan
GROUP BY kota_bersih
HAVING jumlah > 1;</code></pre>

            <h3>Klausa Umum Lainnya</h3>
            <p><strong>SELECT, FROM, WHERE</strong>: Fondasi dari setiap kueri untuk mengambil data.</p>
            <pre><code>-- Mengambil nama dan email karyawan dari Jakarta (setelah dibersihkan)
SELECT nama, email
FROM data_karyawan
WHERE LOWER(TRIM(kota)) = 'jakarta';</code></pre>
            <p><strong>ORDER BY</strong>: Mengurutkan hasil. <code>ASC</code> untuk menaik (default), <code>DESC</code> untuk menurun.</p>
            <pre><code>-- Mengurutkan karyawan berdasarkan gaji dari tertinggi ke terendah
SELECT * FROM data_karyawan ORDER BY gaji DESC;</code></pre>
            <p><strong>LIMIT</strong>: Membatasi jumlah baris yang ditampilkan.</p>
            <pre><code>-- Menampilkan 3 karyawan dengan gaji tertinggi
SELECT * FROM data_karyawan ORDER BY gaji DESC LIMIT 3;</code></pre>
        </div>
    </div>

    <script>
        let db;
        let originalTableName = '';
        let cleanedTableName = null;
        let currentTableName = '';
        let tableHeaders = [];

        const ui = {
            runButton: document.getElementById('run-button'),
            queryTextarea: document.getElementById('sql-query'),
            errorDiv: document.getElementById('error-message'),
            exportBtn: document.getElementById('export-csv-button'),
            uploadInput: document.getElementById('csv-upload'),
            analyzeBtn: document.getElementById('analyze-data-btn'),
            cleanBtn: document.getElementById('clean-data-btn'),
            helpBtn: document.getElementById('help-button'),
            helpModal: document.getElementById('help-modal'),
            analysisReportDiv: document.getElementById('analysis-report'),
            cleaningLogDiv: document.getElementById('cleaning-log'),
            sampleQueriesSelect: document.getElementById('sample-queries'),
            activeTableNameSpan: document.getElementById('active-table-name'),
            dataSourceButtons: document.getElementById('data-source-buttons'),
            uploadStatus: document.getElementById('upload-status'),
            samplePreviewTable: document.getElementById('sample-data-preview-table')
        };

        const sampleData = {
            tableName: 'data_karyawan',
            headers: ['id', 'nama', 'email', 'kota', 'gaji'],
            rows: [
                [1, '  Budi Santoso ', 'budi.santoso@example.com', 'Jakarta', 5000000],
                [2, 'siti aminah', 'siti.aminah@example.com', 'jakarta', 6500000],
                [3, 'Andi Wijaya', null, '  Bandung ', 7000000],
                [4, ' DEWI LESTARI ', 'dewi@example.com', 'Surabaya', 5500000],
                [5, 'Rahmat Hidayat', 'rahmat.h@example.com', 'yogyakarta', null],
                [6, 'Joko Susilo', 'joko@example.com', 'JAKARTA', 8000000],
                [7, 'siti aminah', 'siti.aminah@example.com', 'jakarta', 6500000],
                [8, '  Ahmad Yani', 'ahmad.y@example.com', 'Bandung', 7200000],
                [9, 'Maria Tilaar', 'maria.t@example.com', 'surabaya', 6800000],
                [10, 'Eko Prasetyo', null, '  Yogyakarta  ', 5100000],
                [11, 'Lina Marlina', 'lina.marlina@example.com', 'JAKARTA', 9500000],
                [12, '  Bambang Pamungkas', 'bambang@example.com', 'Jakarta', 8500000],
                [13, 'Cahya Gumilar', 'cahya.g@example.com', 'bandung', 6200000],
                [14, 'Dian Permata', 'dian.p@example.com', 'surabaya', null],
                [15, 'Fajar Nugraha', 'fajar.n@example.com', 'Yogyakarta', 5300000],
                [16, 'Gita Gutawa', 'gita.g@example.com', 'jakarta', 12000000],
                [17, 'Hendra Setiawan', null, '  jakarta', 11000000],
                [18, 'Indah Purnama', 'indah.p@example.com', 'Bandung', 7800000],
                [19, '  Joko Susilo', 'joko@example.com', 'JAKARTA', 8000000],
                [20, 'Kartika Sari', 'kartika.s@example.com', 'Surabaya', 7100000]
            ]
        };

        async function main() {
            try {
                const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}` });
                db = new SQL.Database();
                populateSampleDataPreview();
                setupEventListeners();
                loadDataIntoDB(sampleData.tableName, sampleData.headers, sampleData.rows, true); // Pass true for pre-parsed sample data
            } catch (e) {
                showError("Tidak dapat memuat database.");
            }
        }

        function setupEventListeners() {
            ui.uploadInput.addEventListener('change', handleFileUpload);
            ui.runButton.addEventListener('click', runQuery);
            ui.analyzeBtn.addEventListener('click', analyzeData);
            ui.cleanBtn.addEventListener('click', cleanData);
            ui.exportBtn.addEventListener('click', exportToCSV);
            ui.sampleQueriesSelect.addEventListener('change', (event) => {
                ui.queryTextarea.value = event.target.value;
                runQuery();
            });
            ui.helpBtn.addEventListener('click', () => { ui.helpModal.style.display = 'flex'; });
            ui.helpModal.querySelector('.close-button').addEventListener('click', () => { ui.helpModal.style.display = 'none'; });
            ui.helpModal.addEventListener('click', (e) => {
                if (e.target === ui.helpModal) {
                    ui.helpModal.style.display = 'none';
                }
            });
        }

        function populateSampleDataPreview() {
            const table = ui.samplePreviewTable;
            let html = '<thead><tr>';
            sampleData.headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';
            sampleData.rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${cell === null ? 'NULL' : cell}</td>`);
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }
        
        function parseCsvLine(line) {
            const result = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && line[i+1] === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(currentField);
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField);
            return result;
        }

        function loadDataIntoDB(tableName, headers, dataRows, isPreParsed = false) {
            try {
                ui.uploadStatus.innerHTML = `Memproses <strong>${tableName}</strong>...`;
                db.run(`DROP TABLE IF EXISTS ${tableName};`);
                db.run(`DROP TABLE IF EXISTS ${tableName}_clean;`);
                
                const createTableSql = `CREATE TABLE ${tableName} (${headers.map(h => `"${h}" TEXT`).join(', ')});`;
                db.run(createTableSql);
                
                originalTableName = tableName;
                cleanedTableName = null;
                tableHeaders = headers;
                
                processRowsInChunks(tableName, headers, dataRows, 0, isPreParsed);

            } catch(err) {
                showError(`Gagal memuat data: ${err.message}`);
                ui.uploadStatus.textContent = "Gagal memuat. Silakan coba lagi.";
            }
        }
        
        function processRowsInChunks(tableName, headers, rows, startIndex, isPreParsed) {
            const chunkSize = 100;
            const totalRows = rows.length;
            let endIndex = startIndex + chunkSize;
            if (endIndex > totalRows) {
                endIndex = totalRows;
            }

            const stmt = db.prepare(`INSERT INTO ${tableName} VALUES (${headers.map(() => '?').join(', ')})`);
            for (let i = startIndex; i < endIndex; i++) {
                const parsedRow = isPreParsed ? rows[i].map(cell => String(cell === null ? '' : cell)) : parseCsvLine(rows[i]);
                if (parsedRow.length === headers.length) {
                    stmt.run(parsedRow);
                } else {
                    console.warn(`Skipping malformed row ${i+1}: Expected ${headers.length} columns, but found ${parsedRow.length}.`);
                }
            }
            stmt.free();
            
            ui.uploadStatus.innerHTML = `Memproses baris ${endIndex} dari ${totalRows}...`;

            if (endIndex < totalRows) {
                setTimeout(() => processRowsInChunks(tableName, headers, rows, endIndex, isPreParsed), 0);
            } else {
                ui.uploadStatus.textContent = "";
                switchActiveTable(originalTableName);
                updateDataSourceUI();
            }
        }

        function switchActiveTable(tableName) {
            currentTableName = tableName;
            ui.activeTableNameSpan.textContent = `'${currentTableName}'`;
            populateSampleQueries(currentTableName);
            ui.queryTextarea.value = ui.sampleQueriesSelect.value;
            runQuery();
            updateDataSourceUI();
            ui.analysisReportDiv.innerHTML = '';
            ui.cleaningLogDiv.style.display = 'none';
        }

        function updateDataSourceUI() {
            ui.dataSourceButtons.innerHTML = '';
            const tables = [originalTableName];
            if (cleanedTableName) {
                tables.push(cleanedTableName);
            }
            tables.forEach(tableName => {
                const btn = document.createElement('button');
                btn.textContent = tableName;
                btn.className = 'data-source-btn';
                if (tableName === currentTableName) {
                    btn.classList.add('active');
                }
                btn.onclick = () => switchActiveTable(tableName);
                ui.dataSourceButtons.appendChild(btn);
            });
        }

        function populateSampleQueries(tableName) {
            const queries = [
                { name: `1. Tampilkan Semua Data`, query: `SELECT * FROM ${tableName} LIMIT 20;` },
                { name: `2. Hitung Jumlah Baris`, query: `SELECT COUNT(*) AS total_baris FROM ${tableName};` },
                { name: `3. Tampilkan Gaji > 6 Juta`, query: `SELECT * FROM ${tableName} WHERE gaji > 6000000;` },
                { name: `4. Cari Nama 'siti' (Case-Insensitive)`, query: `SELECT * FROM ${tableName} WHERE LOWER(nama) LIKE '%siti%';` },
                { name: `5. Tampilkan Data Email Kosong`, query: `SELECT * FROM ${tableName} WHERE email IS NULL OR email = '';` },
                { name: `6. Urutkan Karyawan by Nama (A-Z)`, query: `SELECT * FROM ${tableName} ORDER BY nama ASC;` },
                { name: `7. Rata-rata Gaji per Kota`, query: `SELECT LOWER(TRIM(kota)) as kota, CAST(AVG(gaji) AS INTEGER) as rata_rata_gaji FROM ${tableName} GROUP BY LOWER(TRIM(kota));` },
                { name: `8. Tampilkan 3 Gaji Tertinggi`, query: `SELECT * FROM ${tableName} ORDER BY gaji DESC LIMIT 3;` },
                { name: `9. Lihat Variasi Penulisan Kota`, query: `SELECT DISTINCT kota FROM ${tableName};` },
                { name: `10. Ganti Gaji Kosong dengan 0`, query: `SELECT nama, email, kota, COALESCE(gaji, 0) AS gaji_diperbaiki FROM ${tableName};` },
                { name: `11. Kategorikan Level Gaji (CASE)`, query: `SELECT nama, gaji,\nCASE\n    WHEN gaji > 7000000 THEN 'Tinggi'\n    WHEN gaji > 5000000 THEN 'Menengah'\n    ELSE 'Standar'\nEND AS level_gaji\nFROM ${tableName};` },
                { name: `12. Hitung Panjang Nama Karyawan`, query: `SELECT nama, LENGTH(nama) AS panjang_nama FROM ${tableName};` }
            ];
            ui.sampleQueriesSelect.innerHTML = '';
            queries.forEach(item => {
                const option = document.createElement('option');
                option.value = item.query;
                option.textContent = item.name;
                ui.sampleQueriesSelect.appendChild(option);
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                const lines = csvText.trim().split('\n').map(r => r.trim());
                const headers = parseCsvLine(lines.shift()).map(h => h.trim().replace(/"/g, '').replace(/[^a-zA-Z0-9_]/g, '_'));
                const tableName = file.name.replace(/\.[^/.]+$/, "").replace(/[^a-zA-Z0-9_]/g, '_');
                loadDataIntoDB(tableName, headers, lines, false); // Pass false for raw CSV lines
            };
            reader.readAsText(file);
        }

        function analyzeData() {
            if (!currentTableName) return;
            ui.analysisReportDiv.innerHTML = '<h3>Laporan Analisis Kualitas Data</h3>';
            let issuesFound = 0;
            const runAnalysis = (title, query, description) => {
                try {
                    const res = db.exec(query);
                    if (res.length > 0 && res[0].values.length > 0) {
                        issuesFound++;
                        let reportHTML = `<h4>${issuesFound}. ${title}</h4><p>${description}</p>`;
                        reportHTML += renderResultAsTable(res[0]);
                        ui.analysisReportDiv.innerHTML += reportHTML;
                    }
                } catch (e) { console.error(`Analysis error for ${title}:`, e); }
            };
            runAnalysis("Nilai Kosong (NULL)", `SELECT * FROM ${currentTableName} WHERE ${tableHeaders.map(h => `"${h}" IS NULL OR "${h}" = ''`).join(' OR ')}`, "Baris berikut memiliki kolom kosong.");
            runAnalysis("Spasi Berlebih", `SELECT * FROM ${currentTableName} WHERE ${tableHeaders.map(h => `"${h}" != TRIM("${h}")`).join(' OR ')}`, "Baris berikut memiliki spasi ekstra.");
            runAnalysis("Data Duplikat", `SELECT *, COUNT(*) as jumlah FROM ${currentTableName} GROUP BY ${tableHeaders.map(h => `"${h}"`).join(', ')} HAVING COUNT(*) > 1`, "Baris berikut ini duplikat.");
            if (issuesFound === 0) ui.analysisReportDiv.innerHTML += '<p style="color: green; font-weight: bold;">Tidak ada masalah kualitas data umum yang terdeteksi.</p>';
        }
        
        function renderResultAsTable(result) {
            let html = '<div class="data-table-wrapper"><table class="preview-table"><thead><tr>';
            result.columns.forEach(col => html += `<th>${col}</th>`);
            html += '</tr></thead><tbody>';
            result.values.forEach(row => {
                html += '<tr>';
                row.forEach(cell => html += `<td>${cell === null ? 'NULL' : cell}</td>`);
                html += '</tr>';
            });
            return html + '</tbody></table></div>';
        }

        async function cleanData() {
            if (!originalTableName) return;
            
            cleanedTableName = originalTableName + '_clean';
            ui.cleaningLogDiv.style.display = 'block';
            ui.cleaningLogDiv.innerHTML = '';
            const log = (message) => { ui.cleaningLogDiv.innerHTML += `> ${message}\n`; ui.cleaningLogDiv.scrollTop = ui.cleaningLogDiv.scrollHeight; };
            const sleep = ms => new Promise(res => setTimeout(res, ms));

            try {
                log("Memulai proses pembersihan...");
                await sleep(300);

                log(`Menduplikasi tabel '${originalTableName}' ke '${cleanedTableName}'...`);
                db.run(`DROP TABLE IF EXISTS ${cleanedTableName}`);
                db.run(`CREATE TABLE ${cleanedTableName} AS SELECT * FROM ${originalTableName}`);
                await sleep(500);

                log("Menghapus spasi & menyeragamkan format...");
                tableHeaders.forEach(h => db.run(`UPDATE ${cleanedTableName} SET "${h}" = LOWER(TRIM("${h}"))`));
                await sleep(500);

                log("Mengisi nilai kosong (NULL)...");
                tableHeaders.forEach(h => {
                    const lc = h.toLowerCase();
                    const fillVal = (lc.includes('gaji') || lc.includes('id')) ? 0 : 'N/A';
                    db.run(`UPDATE ${cleanedTableName} SET "${h}" = '${fillVal}' WHERE "${h}" IS NULL OR "${h}" = ''`);
                });
                await sleep(500);

                log("Menghapus data duplikat...");
                const preCleanCount = db.exec(`SELECT COUNT(*) FROM ${cleanedTableName}`)[0].values[0][0];
                db.run(`DELETE FROM ${cleanedTableName} WHERE rowid NOT IN (SELECT MIN(rowid) FROM ${cleanedTableName} GROUP BY ${tableHeaders.map(h => `"${h}"`).join(', ')})`);
                const postCleanCount = db.exec(`SELECT COUNT(*) FROM ${cleanedTableName}`)[0].values[0][0];
                const deletedRows = preCleanCount - postCleanCount;
                log(`[OK] ${deletedRows} baris duplikat dihapus.`);
                await sleep(300);

                log("\nPROSES SELESAI!");
                updateDataSourceUI();
                switchActiveTable(cleanedTableName);

            } catch (e) {
                showError(`Gagal membersihkan data: ${e.message}`);
                log(`[ERROR] ${e.message}`);
            }
        }

        function runQuery() {
            const query = ui.queryTextarea.value;
            if (!query.trim()) return;
            const table = document.getElementById('result-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';
            ui.errorDiv.style.display = 'none';
            ui.exportBtn.style.display = 'none';
            try {
                const results = db.exec(query);
                if (results.length === 0) {
                    tbody.innerHTML = '<tr><td>Kueri berhasil dijalankan, tidak ada hasil.</td></tr>';
                    return;
                }
                const { columns, values } = results[0];
                thead.innerHTML = `<tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>`;
                if (values.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${columns.length}">Tidak ada hasil.</td></tr>`;
                } else {
                    tbody.innerHTML = values.map(row => `<tr>${row.map(cell => `<td>${cell === null ? 'NULL' : cell}</td>`).join('')}</tr>`).join('');
                    ui.exportBtn.style.display = 'inline-block';
                }
            } catch (e) {
                showError(`SQL Error: ${e.message}`);
            }
        }
        
        function exportToCSV() {
            const query = ui.queryTextarea.value;
            if(!query) return;
            const results = db.exec(query);
            if (results.length === 0) return alert("Tidak ada data untuk diekspor.");
            
            const { columns, values } = results[0];
            const header = columns.join(',');
            const rows = values.map(rowArray => rowArray.map(cell => {
                const cellStr = String(cell === null ? '' : cell);
                return cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n') ? `"${cellStr.replace(/"/g, '""')}"` : cellStr;
            }).join(','));
            const csvContent = [header, ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "hasil_kueri.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function showError(message) {
            ui.errorDiv.textContent = message;
            ui.errorDiv.style.display = 'block';
        }

        main();
    </script>
</body>
</html>
