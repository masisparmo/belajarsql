<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mudah Belajar SQL - Live SQL Query Runner</title>
    <!-- Memuat pustaka sql.js dari CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <!-- Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4 md:p-6 lg:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">Live SQL Query Runner</h1>
            <p class="mt-2 text-gray-600">Jalankan kueri SQL secara langsung di browser Anda menggunakan data tabel di bawah ini.</p>
        </header>

        <!-- Sample Data Section -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <h3 class="font-bold text-lg mb-2 text-gray-700">Contoh Data Tabel: <code class="bg-gray-200 text-sm p-1 rounded">karyawan</code></h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2">id</th>
                            <th class="p-2">nama</th>
                            <th class="p-2">email</th>
                            <th class="p-2">kota</th>
                            <th class="p-2">gaji</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <tr><td class="p-2">1</td><td class="p-2">'  Budi Santoso '</td><td class="p-2">'budi.santoso@example.com'</td><td class="p-2">'Jakarta'</td><td class="p-2">5000000</td></tr>
                        <tr><td class="p-2">2</td><td class="p-2">'siti aminah'</td><td class="p-2">'siti.aminah@example.com'</td><td class="p-2">'jakarta'</td><td class="p-2">6500000</td></tr>
                        <tr><td class="p-2">3</td><td class="p-2">'Andi Wijaya'</td><td class="p-2 italic text-gray-500">NULL</td><td class="p-2">'  Bandung '</td><td class="p-2">7000000</td></tr>
                        <tr><td class="p-2">4</td><td class="p-2">' DEWI LESTARI '</td><td class="p-2">'dewi@example.com'</td><td class="p-2">'Surabaya'</td><td class="p-2">5500000</td></tr>
                        <tr><td class="p-2">5</td><td class="p-2">'Rahmat Hidayat'</td><td class="p-2">'rahmat.h@example.com'</td><td class="p-2">'yogyakarta'</td><td class="p-2 italic text-gray-500">NULL</td></tr>
                        <tr><td class="p-2">6</td><td class="p-2">'Joko Susilo'</td><td class="p-2">'joko@example.com'</td><td class="p-2">'JAKARTA'</td><td class="p-2">8000000</td></tr>
                    </tbody>
                </table>
            </div>
            <details class="mt-4 text-xs text-gray-600">
                <summary class="cursor-pointer font-medium">Karakteristik Data "Tidak Bersih"</summary>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li><strong>Spasi Ekstra:</strong> Kolom <code>nama</code> dan <code>kota</code> memiliki spasi di awal/akhir.</li>
                    <li><strong>Kapitalisasi Tidak Konsisten:</strong> Kolom <code>nama</code> dan <code>kota</code> menggunakan campuran huruf besar dan kecil.</li>
                    <li><strong>Nilai NULL:</strong> Kolom <code>email</code> dan <code>gaji</code> memiliki data kosong (NULL).</li>
                </ul>
            </details>
        </div>

        <!-- Main Content: Query and Result -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Query Box -->
            <div class="w-full lg:w-2/5 flex flex-col gap-4">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <label for="sample-queries" class="font-bold text-gray-700">Pilih Contoh Kueri:</label>
                        <button id="help-button" class="bg-gray-600 text-white text-xs px-3 py-1 rounded-md hover:bg-gray-700 transition-colors">Bantuan SQL</button>
                    </div>
                    <select id="sample-queries" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md flex-grow flex flex-col">
                     <textarea id="sql-query" placeholder="SELECT * FROM karyawan;" class="w-full h-48 flex-grow p-2 border border-gray-300 rounded-md font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                     <div class="mt-4 flex items-center gap-4">
                        <button id="run-button" class="bg-blue-600 text-white font-bold px-5 py-2 rounded-md hover:bg-blue-700 transition-colors">Run Query</button>
                        <button id="export-csv-button" class="bg-green-600 text-white font-bold px-5 py-2 rounded-md hover:bg-green-700 transition-colors" style="display: none;">Export to CSV</button>
                    </div>
                </div>
            </div>

            <!-- Result Container -->
            <div class="w-full lg:w-3/5 bg-white p-4 rounded-lg shadow-md min-h-[300px] flex flex-col">
                <div id="error-message" class="text-red-600 font-bold mb-2 whitespace-pre-wrap"></div>
                <div class="overflow-auto flex-grow">
                    <table id="result-table" class="w-full text-sm text-left">
                        <thead class="bg-gray-50 sticky top-0"></thead>
                        <tbody class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for SQL Help -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">Panduan Lengkap Sintaks dan Fungsi SQL</h2>
                <button class="close-button text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </header>
            <main class="p-6 overflow-y-auto space-y-6">
                <!-- Help sections go here -->
                <div class="help-section bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                    <h3 class="font-bold text-blue-800">Analisis dan Pembersihan Data (Data Cleaning)</h3>
                    <p class="text-sm mt-1">Fungsi-fungsi ini sangat berguna untuk data yang tidak bersih seperti pada tabel contoh <code>karyawan</code>.</p>
                    <div class="mt-2 space-y-2 text-sm">
                        <p><strong>Menemukan Nilai Kosong (NULL)</strong></p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Mencari karyawan yang gajinya belum diisi
SELECT nama, gaji FROM karyawan WHERE gaji IS NULL;</code></pre>
                        <p><strong>TRIM()</strong>: Menghapus spasi di awal dan akhir teks.</p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Membersihkan spasi dari kolom nama
SELECT nama, TRIM(nama) AS nama_bersih FROM karyawan;</code></pre>
                        <p><strong>LOWER() / UPPER()</strong>: Mengubah teks menjadi huruf kecil atau besar.</p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Menyeragamkan data kota menjadi huruf kecil
SELECT kota, LOWER(TRIM(kota)) AS kota_standar FROM karyawan;</code></pre>
                         <p><strong>COALESCE()</strong>: Mengganti nilai NULL dengan nilai default.</p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Mengganti gaji yang kosong dengan 0
SELECT nama, COALESCE(gaji, 0) AS gaji_final FROM karyawan;</code></pre>
                        <p><strong>CASE Statement</strong>: Menerapkan logika kondisional (if-then-else).</p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Mengkategorikan gaji karyawan
SELECT nama, gaji,
CASE
    WHEN gaji > 6000000 THEN 'Gaji Tinggi'
    ELSE 'Gaji Standar'
END AS level_gaji
FROM karyawan;</code></pre>
                    </div>
                </div>

                <div class="help-section">
                    <h3 class="font-bold text-gray-700">Data Manipulation Language (DML)</h3>
                    <div class="mt-2 space-y-2 text-sm">
                        <p><strong>SELECT</strong>: Mengambil data dari tabel.</p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Mengambil nama dan kota dari karyawan di 'jakarta' (case-insensitive)
SELECT nama, kota FROM karyawan WHERE LOWER(TRIM(kota)) = 'jakarta';</code></pre>
                        <p><strong>INSERT INTO</strong>: Menambahkan data baru.</p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Menambahkan karyawan baru
INSERT INTO karyawan (nama, email, kota, gaji)
VALUES ('Slamet Riyadi', 'slamet@example.com', 'Solo', 6000000);</code></pre>
                    </div>
                </div>
                
                <div class="help-section">
                    <h3 class="font-bold text-gray-700">Fungsi Agregat dan Pengelompokan</h3>
                     <div class="mt-2 space-y-2 text-sm">
                        <p><strong>GROUP BY</strong>: Mengelompokkan baris berdasarkan nilai kolom.</p>
                        <pre class="bg-gray-200 p-2 rounded text-xs"><code>-- Menghitung jumlah karyawan per kota (setelah dibersihkan)
SELECT LOWER(TRIM(kota)) AS kota, COUNT(id)
FROM karyawan
GROUP BY LOWER(TRIM(kota));</code></pre>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // Definisikan variabel global untuk database
        let db;
        let lastSuccessfulResult = null;

        // Fungsi untuk menjalankan kueri dan menampilkan hasilnya
        function runQuery() {
            const query = document.getElementById('sql-query').value;
            const table = document.getElementById('result-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const errorDiv = document.getElementById('error-message');
            const exportBtn = document.getElementById('export-csv-button');

            // Bersihkan hasil sebelumnya
            thead.innerHTML = '';
            tbody.innerHTML = '';
            errorDiv.textContent = '';
            exportBtn.style.display = 'none';
            lastSuccessfulResult = null;

            try {
                // Jalankan kueri menggunakan sql.js
                const results = db.exec(query);

                if (results.length === 0) {
                    tbody.innerHTML = '<tr><td class="p-4 text-gray-500">Query executed successfully, no results to display.</td></tr>';
                    return;
                }

                // Kita hanya akan menampilkan hasil dari statement pertama
                const { columns, values } = results[0];

                // Buat header tabel
                const headerRow = document.createElement('tr');
                columns.forEach(colName => {
                    const th = document.createElement('th');
                    th.textContent = colName;
                    th.className = 'p-2 font-bold text-left';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                if (values.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${columns.length}" class="p-4 text-center text-gray-500">No results found.</td></tr>`;
                    return;
                }

                // Isi baris data
                values.forEach(rowData => {
                    const row = document.createElement('tr');
                    rowData.forEach(cellData => {
                        const td = document.createElement('td');
                        td.textContent = cellData;
                        td.className = 'p-2';
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                });

                // Simpan hasil dan tampilkan tombol ekspor
                lastSuccessfulResult = { columns, values };
                exportBtn.style.display = 'inline-block';

            } catch (e) {
                // Tampilkan pesan error jika kueri gagal
                errorDiv.textContent = `SQL Error: ${e.message}`;
            }
        }

        // Fungsi untuk mengekspor data ke CSV
        function exportToCSV() {
            if (!lastSuccessfulResult || lastSuccessfulResult.values.length === 0) {
                // Menggunakan modal custom sebagai pengganti alert
                showCustomAlert("Tidak ada data untuk diekspor.");
                return;
            }

            const { columns, values } = lastSuccessfulResult;

            const header = columns.join(',');
            const rows = values.map(rowArray => {
                return rowArray.map(cell => {
                    const cellStr = String(cell === null ? '' : cell);
                    if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                        return `"${cellStr.replace(/"/g, '""')}"`;
                    }
                    return cellStr;
                }).join(',');
            });

            const csvContent = [header, ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "hasil_kueri.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Fungsi untuk menampilkan alert custom
        function showCustomAlert(message) {
            const alertBox = document.createElement('div');
            alertBox.className = 'fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg animate-pulse';
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        }

        // Fungsi utama untuk inisialisasi database
        async function main() {
            // Inisialisasi sql.js dengan file wasm-nya
            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
            });

            // Buat database baru di memori browser
            db = new SQL.Database();

            db.run(`
                CREATE TABLE karyawan (
                    id INTEGER PRIMARY KEY,
                    nama TEXT NOT NULL,
                    email TEXT,
                    kota TEXT,
                    gaji INTEGER
                );
            `);

            const unclean_data = [
                ['  Budi Santoso ', 'budi.santoso@example.com', 'Jakarta', 5000000],
                ['siti aminah', 'siti.aminah@example.com', 'jakarta', 6500000],
                ['Andi Wijaya', null, '  Bandung ', 7000000],
                [' DEWI LESTARI ', 'dewi@example.com', 'Surabaya', 5500000],
                ['Rahmat Hidayat', 'rahmat.h@example.com', 'yogyakarta', null],
                ['Joko Susilo', 'joko@example.com', 'JAKARTA', 8000000],
            ];

            const stmt = db.prepare("INSERT INTO karyawan (nama, email, kota, gaji) VALUES (?, ?, ?, ?)");
            unclean_data.forEach(row => {
                stmt.run(row);
            });
            stmt.free();

            const sampleQueries = [
                { name: "1. Tampilkan Semua Data (Kotor)", query: "SELECT * FROM karyawan;" },
                { 
                    name: "2. Bersihkan Nama dan Kota (TRIM & LOWER)", 
                    query: "SELECT\n    TRIM(nama) AS nama_bersih,\n    LOWER(TRIM(kota)) AS kota_bersih,\n    email,\n    gaji\nFROM\n    karyawan;" 
                },
                { 
                    name: "3. Tangani Gaji NULL (COALESCE)", 
                    query: "SELECT\n    nama,\n    email,\n    kota,\n    COALESCE(gaji, 0) AS gaji_final\nFROM\n    karyawan;" 
                },
                { 
                    name: "4. Kelompokkan Berdasarkan Kota (GROUP BY)", 
                    query: "SELECT\n    LOWER(TRIM(kota)) AS kota,\n    COUNT(id) AS jumlah_karyawan,\n    AVG(COALESCE(gaji, 0)) AS rata_rata_gaji\nFROM\n    karyawan\nGROUP BY\n    LOWER(TRIM(kota));" 
                },
                { 
                    name: "5. Filter Karyawan dari Jakarta (WHERE)", 
                    query: "SELECT *\nFROM karyawan\nWHERE LOWER(TRIM(kota)) = 'jakarta';" 
                }
            ];

            const queryTextarea = document.getElementById('sql-query');
            const sampleQueriesSelect = document.getElementById('sample-queries');

            sampleQueries.forEach(item => {
                const option = document.createElement('option');
                option.value = item.query;
                option.textContent = item.name;
                sampleQueriesSelect.appendChild(option);
            });

            sampleQueriesSelect.addEventListener('change', (event) => {
                queryTextarea.value = event.target.value;
                runQuery();
            });

            queryTextarea.value = sampleQueries[0].query;
            runQuery();

            document.getElementById('run-button').addEventListener('click', runQuery);
            document.getElementById('export-csv-button').addEventListener('click', exportToCSV);

            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const closeButton = helpModal.querySelector('.close-button');

            helpButton.addEventListener('click', () => {
                helpModal.style.display = 'flex';
            });

            function closeModal() {
                helpModal.style.display = 'none';
            }

            closeButton.addEventListener('click', closeModal);

            helpModal.addEventListener('click', (event) => {
                if (event.target === helpModal) {
                    closeModal();
                }
            });
        }

        main().catch(e => console.error(e));
    </script>
</body>
</html>
